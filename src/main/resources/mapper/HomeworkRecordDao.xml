<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dao.HomeworkRecordDao">


    <select id="selectGroupBy" resultType="com.entity.view.HomeworkRecordView">
        SELECT
        p.id AS homeworkId,
        p.title AS homeworkName,
        cc.course AS course,
        qb.id AS questionId,
        qb.title AS title,
        qb.options AS options,
        qb.answer AS answer,
        qb.analysis AS analysis,
        qb.type AS type,
        qb.score AS score,
        COUNT(1) AS total,
        ROUND(SUM(CASE WHEN r.myscore > 0 THEN 1 ELSE 0 END) / COUNT(1), 2) AS accuracy,
        SUM(CASE WHEN r.myanswer LIKE '%A%' THEN 1 ELSE 0 END) AS anum,
        SUM(CASE WHEN r.myanswer LIKE '%B%' THEN 1 ELSE 0 END) AS bnum,
        SUM(CASE WHEN r.myanswer LIKE '%C%' THEN 1 ELSE 0 END) AS cnum,
        SUM(CASE WHEN r.myanswer LIKE '%D%' THEN 1 ELSE 0 END) AS dnum
        FROM record r
        LEFT JOIN paper p ON r.paperid = p.id
        LEFT JOIN question_bank qb ON r.question_id = qb.id
        LEFT JOIN question q ON q.question_id = qb.id
        LEFT JOIN course_categories cc ON cc.id = qb.course_id
        WHERE p.status = '0'  -- 只取作业数据
        <if test="ew != null">
            ${ew.sqlSegment}
        </if>
        GROUP BY
        p.id, p.title, cc.course,
        qb.id, qb.title, qb.options, qb.answer,
        qb.analysis, qb.type, qb.score
    </select>
    <select id="selectOptionsNum" resultType="com.entity.view.HomeworkRecordView">
        SELECT
        p.id AS homeworkId,
        p.title AS homeworkName,
        cc.course AS course,
        qb.id AS questionId,
        qb.title AS title,
        qb.options AS options,
        qb.answer AS answer,
        qb.analysis AS analysis,
        qb.type AS type,
        qb.score AS score,
        COUNT(1) AS total,
        ROUND(SUM(CASE WHEN r.myscore > 0 THEN 1 ELSE 0 END) / COUNT(1), 2) AS accuracy,
        SUM(CASE WHEN r.myanswer LIKE '%A%' THEN 1 ELSE 0 END) AS anum,
        SUM(CASE WHEN r.myanswer LIKE '%B%' THEN 1 ELSE 0 END) AS bnum,
        SUM(CASE WHEN r.myanswer LIKE '%C%' THEN 1 ELSE 0 END) AS cnum,
        SUM(CASE WHEN r.myanswer LIKE '%D%' THEN 1 ELSE 0 END) AS dnum
        FROM record r
        LEFT JOIN paper p ON r.paperid = p.id
        LEFT JOIN question_bank qb ON r.question_id = qb.id
        LEFT JOIN question q ON q.question_id = qb.id
        LEFT JOIN course_categories cc ON cc.id = qb.course_id
        WHERE p.status = '0'  -- 只取作业数据
        <if test="ew != null">
             ${ew.sqlSegment}
        </if>
        GROUP BY
        p.id, p.title, cc.course,
        qb.id, qb.title, qb.options, qb.answer,
        qb.analysis, qb.type, qb.score
    </select>
    <select id="selectListView" resultType="com.entity.view.HomeworkRecordView">
        SELECT
        r.*,
        p.title AS homeworkName,
        q.paperid AS homeworkId,
        cc.course AS course,
        qb.title AS title,
        qb.options AS options,
        qb.answer AS answer,
        qb.analysis AS analysis,
        qb.type AS type,
        qb.score AS score
        FROM record r
        LEFT JOIN paper p ON r.paperid = p.id
        LEFT JOIN question_bank qb ON r.question_id = qb.id
        LEFT JOIN question q ON q.question_id = qb.id
        LEFT JOIN course_categories cc ON cc.id = qb.course_id
        WHERE p.status = '0'  -- 只取作业数据
        <if test="ew != null">
             ${ew.sqlSegment}
        </if>
    </select>
    <select id="selectView" resultType="com.entity.view.HomeworkRecordView">
        SELECT
        r.*,
        p.title AS homeworkName,
        q.paperid AS homeworkId,
        cc.course AS course,
        qb.title AS title,
        qb.options AS options,
        qb.answer AS answer,
        qb.analysis AS analysis,
        qb.type AS type,
        qb.score AS score
        FROM record r
        LEFT JOIN paper p ON r.paperid = p.id
        LEFT JOIN question_bank qb ON r.question_id = qb.id
        LEFT JOIN question q ON q.question_id = qb.id
        LEFT JOIN course_categories cc ON cc.id = qb.course_id
        WHERE p.status = '0'  -- 只取作业数据
        <if test="ew != null">
             ${ew.sqlSegment}
        </if>
    </select>
</mapper>