<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dao.ExamRecordDao">
    <select id="selectExamStudentResultList" resultType="com.entity.vo.ExamStudentResultVO">
        SELECT
            eh.id AS examHomeworkId,
            r.s_username AS studentUsername,
            us.s_name AS studentName,
            eh.name AS examName,
            cc.course AS courseName,
            SUM(r.myscore) AS totalScore,
            DATE_FORMAT(MIN(r.addtime), '%Y-%m-%d %H:%i') AS submitTime
        FROM record r
                 LEFT JOIN paper p ON r.paperid = p.id
                 LEFT JOIN exam_homework eh ON p.id = eh.paper_id
                 LEFT JOIN course_categories cc ON p.course_id = cc.id
                 LEFT JOIN user_student us ON r.s_username = us.s_username
        WHERE p.t_username = #{teacherUsername}
        GROUP BY eh.id, r.paperid, r.s_username, eh.name, cc.course, us.s_name
    </select>

    <select id="getExamDetailByHomework" resultType="com.entity.vo.ExamDetailVO">
        SELECT
        qb.id AS questionId,
        qb.title AS questionStem,
        qb.answer AS correctAnswer,
        qb.options AS options,
        qb.score AS questionScore,
        r.myanswer AS studentAnswer,
        r.myscore AS studentScore
        FROM record r
        JOIN exam_homework eh ON r.paperid = eh.paper_id
        JOIN question_bank qb ON r.question_id = qb.id
        WHERE eh.id = #{examHomeworkId}
        AND r.s_username = #{studentUsername}
        ORDER BY qb.sequence ASC;

    </select>


    <!-- 查询考试记录视图 -->
<!--    <select id="selectExamRecordDetail" resultType="com.entity.vo.ExamRecordVO">-->
<!--        SELECT-->
<!--            MIN(er.id) AS id,-->
<!--            ep.title AS paperName,-->
<!--            cc.course AS courseType,-->
<!--            us.s_name AS studentName,-->
<!--            DATE_FORMAT(MIN(er.addtime), '%Y-%m-%d %H:%i') AS submitTime,-->
<!--            SUM(er.myscore) AS score,-->
<!--            CASE WHEN MIN(er.ismark) = 1 THEN '已批改' ELSE '未批改' END AS status-->
<!--        FROM exam_record er-->
<!--                 LEFT JOIN exam_paper ep ON er.paperid = ep.id-->
<!--                 LEFT JOIN course_categories cc ON ep.course_id = cc.id-->
<!--                 LEFT JOIN user_student us ON er.s_username = us.s_username-->
<!--        GROUP BY-->
<!--            er.paperid,-->
<!--            er.s_username,-->
<!--            ep.title,-->
<!--            cc.course,-->
<!--            us.s_name-->
<!--    </select>-->
<!--    <update id="markSingleQuestionById">-->
<!--        UPDATE exam_record-->
<!--        SET myscore = #{score},-->
<!--            ismark = 1-->
<!--        WHERE id = #{id}-->
<!--    </update>-->
<!--    <select id="selectExamDetailQuestions" resultType="com.entity.vo.ExamDetailQuestionVO">-->
<!--        SELECT-->
<!--            er.questionid AS id,-->
<!--            eq.type AS type,-->
<!--            eq.title AS question,-->
<!--            er.myanswer AS studentAnswer,-->
<!--            eq.answer AS correctAnswer-->
<!--        FROM-->
<!--            exam_record er-->
<!--                LEFT JOIN exam_question_bank eq ON er.questionid = eq.id-->
<!--        WHERE-->
<!--            er.paperid = #{paperId}-->
<!--          AND er.s_username = #{sUsername}-->
<!--    </select>-->




    <!--    &lt;!&ndash; 可根据自己的需求，是否要使用 &ndash;&gt;-->
<!--    <resultMap type="com.entity.ExamRecordEntity" id="examrecordMap">-->
<!--        <result property="userid" column="userid"/>-->
<!--        <result property="username" column="username"/>-->
<!--        <result property="paperid" column="paperid"/>-->
<!--        <result property="papername" column="papername"/>-->
<!--        <result property="questionid" column="questionid"/>-->
<!--        <result property="questionname" column="questionname"/>-->
<!--        <result property="options" column="options"/>-->
<!--        <result property="score" column="score"/>-->
<!--        <result property="answer" column="answer"/>-->
<!--        <result property="analysis" column="analysis"/>-->
<!--        <result property="ismark" column="ismark"/>-->
<!--        <result property="type" column="type"/>-->
<!--        <result property="myscore" column="myscore"/>-->
<!--        <result property="myanswer" column="myanswer"/>-->
<!--        <result property="jiaoshigonghao" column="jiaoshigonghao"/>-->
<!--    </resultMap>-->

<!--	<select id="selectListVO"-->
<!--		resultType="com.entity.vo.ExamRecordVO" >-->
<!--		SELECT * FROM examrecord  examrecord         -->
<!--        <where> 1=1 ${ew.sqlSegment}</where>-->
<!--	</select>-->
<!--	-->
<!--	<select id="selectVO"-->
<!--		resultType="com.entity.vo.ExamRecordVO" >-->
<!--		SELECT  examrecord.* FROM examrecord  examrecord 	-->
<!-- 		<where> 1=1 ${ew.sqlSegment}</where>-->
<!--	</select>-->

<!--    <select id="selectListView"-->
<!--		resultType="com.entity.view.ExamRecordView" >-->

<!--		SELECT  examrecord.* FROM examrecord  examrecord 	        -->
<!--        <where> 1=1 ${ew.sqlSegment}</where>-->
<!--	</select>-->
<!--	-->
<!--	<select id="selectView"-->
<!--		resultType="com.entity.view.ExamRecordView" >-->
<!--		SELECT * FROM examrecord  examrecord <where> 1=1 ${ew.sqlSegment}</where>-->
<!--	</select>-->
<!--	-->
<!--	<select id="selectGroupBy"-->
<!--		resultType="com.entity.view.ExamRecordView" >-->
<!--		select userid,username,paperid,papername,sum(myscore) myscore,ROUND(sum(case when myscore>0 then 1 else 0 end)/(sum(1)),2) accuracy,sum(case when type=4 and ismark=0 then 1 else 0 end) ismark from examrecord     -->
<!--        <where> 1=1 ${ew.sqlSegment}</where>-->
<!--        group by userid,username,paperid,papername  -->
<!--	</select>-->

<!--    <select id="selectOptionsNum"-->
<!--        resultType="com.entity.view.ExamRecordView" >-->
<!--        select questionname,options,type,-->
<!--            sum(case when myanswer like '%A%' then 1 else 0 end) anum,-->
<!--            sum(case when myanswer like '%B%' then 1 else 0 end) bnum,-->
<!--            sum(case when myanswer like '%C%' then 1 else 0 end) cnum,-->
<!--            sum(case when myanswer like '%D%' then 1 else 0 end) dnum-->
<!--        from examrecord-->
<!--        <where> 1=1 ${ew.sqlSegment}</where>-->
<!--        group by 1,2,3-->
<!--    </select>-->



</mapper>
